// Prisma Schema for RadBooks Platform
// This is your database schema - serves as the single source of truth

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ORGANIZATIONS & USERS
// ============================================

model Organization {
  versionId       String   @id @default(uuid()) @map("version_id")
  id              String   @default(uuid())
  name            String
  slug            String // URL-friendly identifier (e.g., "grit-hoops") — uniqueness enforced at app level for current versions
  ein             String? // Tax ID / EIN
  mission         String?  @db.Text
  logoUrl         String?  @map("logo_url")
  primaryColor    String?  @map("primary_color")   // Hex color for nav accent (e.g. "#3b82f6")
  accentColor     String?  @map("accent_color")    // Hex color for highlights/links
  fiscalYearStart DateTime @default("2024-01-01T00:00:00Z") @map("fiscal_year_start")

  // Donor settings
  donorAccessMode     DonorAccessMode @default(REQUIRE_APPROVAL) @map("donor_access_mode")
  paymentInstructions String?         @map("payment_instructions") @db.Text
  donationsAccountId  String?         @map("donations_account_id") // Stable entity ID of the designated Revenue account

  // Subscription & Status
  status           OrganizationStatus @default(ACTIVE)
  subscriptionTier SubscriptionTier   @default(FREE)

  // Verification (Phase 1: Organization Verification)
  verificationStatus     VerificationStatus @default(PENDING_VERIFICATION) @map("verification_status")
  einVerifiedAt          DateTime?          @map("ein_verified_at")
  verifiedAt             DateTime?          @map("verified_at")
  verifiedBy             String?            @map("verified_by") // User ID of platform admin who verified
  verificationNotes      String?            @map("verification_notes") @db.Text
  officialWebsite        String?            @map("official_website")
  determinationLetterUrl String?            @map("determination_letter_url")

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // No reverse relation arrays — FKs to Organization are plain string fields resolved at service layer

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_org_current")
  @@index([id, validFrom, validTo], name: "idx_org_valid_time")
  @@index([systemFrom, systemTo], name: "idx_org_system_time")
  @@index([isDeleted], name: "idx_org_deleted")
  @@map("organizations")
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum VerificationStatus {
  PENDING_VERIFICATION
  VERIFIED
  VERIFICATION_FAILED
  SUSPENDED
}

enum SubscriptionTier {
  FREE
  PREMIUM
  ENTERPRISE
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  name      String
  avatarUrl String? @map("avatar_url")

  // External auth ID (Clerk or Supabase)
  authId String @unique @map("auth_id")

  // Platform admin flag (system-wide, not org-specific)
  isPlatformAdmin Boolean @default(false) @map("is_platform_admin")

  // Metrics
  totalDonated Decimal @default(0) @map("total_donated") @db.Decimal(12, 2)

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  organizations   OrganizationUser[]
  donations       Transaction[]      @relation("DonorTransactions")
  contacts        Contact[]          @relation("UserContacts")
  invitationsSent Invitation[]       @relation("InvitationsSent")
  accessRequests  AccessRequest[]    @relation("AccessRequests")

  @@map("users")
}

model OrganizationUser {
  versionId      String   @id @default(uuid()) @map("version_id")
  id             String   @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           UserRole @default(DONOR)

  // Donor preferences
  anonymousDonor   Boolean @default(false) @map("anonymous_donor")
  showInHighlights Boolean @default(true) @map("show_in_highlights")

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")

  // Metadata
  joinedAt  DateTime @default(now()) @map("joined_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (only to non-bitemporal User; Organization resolved at service layer)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_orguser_current")
  @@index([id, validFrom, validTo], name: "idx_orguser_valid_time")
  @@index([systemFrom, systemTo], name: "idx_orguser_system_time")
  @@index([isDeleted], name: "idx_orguser_deleted")
  @@map("organization_users")
}

enum UserRole {
  PLATFORM_ADMIN
  ORG_ADMIN
  DONOR
  PUBLIC
}

// ============================================
// CHART OF ACCOUNTS
// ============================================

model Account {
  versionId      String @id @default(uuid()) @map("version_id")
  id             String @default(uuid())
  organizationId String @map("organization_id")

  // Account details
  code        String // e.g., "1000", "1100", "4000"
  name        String // e.g., "Cash", "Checking Account", "Donation Revenue"
  type        AccountType
  description String?     @db.Text

  // Hierarchy
  parentAccountId String? @map("parent_account_id")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Balance (cached, calculated from transactions)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(12, 2)

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // No relations — Organization, parentAccount, and reverse arrays resolved at service layer

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_account_current")
  @@index([id, validFrom, validTo], name: "idx_account_valid_time")
  @@index([systemFrom, systemTo], name: "idx_account_system_time")
  @@index([isDeleted], name: "idx_account_deleted")
  @@map("accounts")
}

enum AccountType {
  ASSET // e.g., Cash, Bank Account, Assets
  LIABILITY // e.g., Loans, Payables
  EQUITY // e.g., Retained Earnings, Fund Balance
  REVENUE // e.g., Donations, Grants, Fundraising
  EXPENSE // e.g., Programs, Administration, Fundraising costs
}

// ============================================
// TRANSACTIONS (Double-Entry Bookkeeping)
// ============================================

model Transaction {
  versionId      String @id @default(uuid()) @map("version_id")
  id             String @default(uuid())
  organizationId String @map("organization_id")

  // Transaction details
  transactionDate DateTime        @map("transaction_date")
  amount          Decimal         @db.Decimal(12, 2)
  type            TransactionType

  // Double-entry bookkeeping
  debitAccountId  String @map("debit_account_id")
  creditAccountId String @map("credit_account_id")

  // Metadata
  description     String        @db.Text
  category        String? // e.g., "Donation", "Equipment", "Travel"
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") // Check #, Venmo ID, etc.

  // Donor information (soft-deprecated: prefer contactId for new transactions)
  donorUserId String? @map("donor_user_id")
  donorName   String? @map("donor_name") // For non-user donors
  isAnonymous Boolean @default(false) @map("is_anonymous")

  // Contact reference (unified payee/payer)
  contactId String? @map("contact_id")

  // Attachments
  receiptUrl String? @map("receipt_url")
  notes      String? @db.Text

  // Reconciliation
  bankTransactionId String?   @map("bank_transaction_id")
  reconciled        Boolean   @default(false)
  reconciledAt      DateTime? @map("reconciled_at")

  // Stripe integration
  stripeSessionId String? @map("stripe_session_id")
  stripePaymentId String? @map("stripe_payment_id")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") // User ID who created
  updatedAt DateTime @updatedAt @map("updated_at")

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")

  // Void-specific fields
  isVoided   Boolean    @default(false) @map("is_voided")
  voidedAt   DateTime?  @map("voided_at")
  voidedBy   String?    @map("voided_by")
  voidReason String?    @map("void_reason") @db.Text
  changeReason String?  @map("change_reason") @db.Text

  // Relations (only to non-bitemporal User; Organization/Account/Contact resolved at service layer)
  donor User? @relation("DonorTransactions", fields: [donorUserId], references: [id])

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_transaction_current")
  @@index([id, validFrom, validTo], name: "idx_transaction_valid_time")
  @@index([systemFrom, systemTo], name: "idx_transaction_system_time")
  @@index([isVoided], name: "idx_transaction_voided")
  @@index([isDeleted], name: "idx_transaction_deleted")
  @@map("transactions")
}

enum TransactionType {
  INCOME // Money coming in
  EXPENSE // Money going out
  TRANSFER // Between accounts
}

enum PaymentMethod {
  STRIPE
  VENMO
  CHECK
  CASH
  BANK_TRANSFER
  OTHER
}

// ============================================
// PLANNED PURCHASES
// ============================================

model ProgramSpending {
  versionId      String @id @default(uuid()) @map("version_id")
  id             String @default(uuid())
  organizationId String @map("organization_id")

  // Spending details
  title           String
  description     String    @db.Text
  estimatedAmount Decimal   @map("estimated_amount") @db.Decimal(12, 2)
  targetDate      DateTime? @map("target_date")

  // Status
  status   SpendingStatus   @default(PLANNED)

  // Completion
  completedAt DateTime? @map("completed_at")

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // No relations — Organization and Transaction resolved at service layer

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_spending_current")
  @@index([id, validFrom, validTo], name: "idx_spending_valid_time")
  @@index([systemFrom, systemTo], name: "idx_spending_system_time")
  @@index([isDeleted], name: "idx_spending_deleted")
  @@map("program_spending")
}

model ProgramSpendingTransaction {
  id                String   @id @default(uuid())
  programSpendingId String   @map("program_spending_id")
  transactionId     String   @map("transaction_id")
  amount            Decimal  @db.Decimal(12, 2)
  linkedAt          DateTime @default(now()) @map("linked_at")
  linkedBy          String?  @map("linked_by")

  @@unique([programSpendingId, transactionId])
  @@index([programSpendingId])
  @@index([transactionId])
  @@map("program_spending_transactions")
}

enum SpendingStatus {
  PLANNED
  PURCHASED
  CANCELLED
}

// ============================================
// BANK ACCOUNTS (Future - Plaid Integration)
// ============================================

model BankAccount {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  accountId      String @unique @map("account_id") // Links to Account (Chart of Accounts) entity ID

  // Bank details
  bankName           String  @map("bank_name")
  accountNumberLast4 String  @map("account_number_last4")
  accountType        String? @map("account_type") // checking, savings

  // Plaid integration
  plaidAccessToken String? @map("plaid_access_token") // Should be encrypted
  plaidItemId      String? @map("plaid_item_id")

  // Status
  isActive     Boolean   @default(true) @map("is_active")
  lastSyncedAt DateTime? @map("last_synced_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Organization and Account are bitemporal — no @relation, resolved at service layer

  @@map("bank_accounts")
}

// ============================================
// AUDIT LOG (Optional but recommended)
// ============================================

model AuditLog {
  id             String  @id @default(uuid())
  organizationId String? @map("organization_id")
  userId         String  @map("user_id")

  action     String // e.g., "CREATE_TRANSACTION", "UPDATE_ACCOUNT"
  entityType String @map("entity_type") // e.g., "Transaction", "Account"
  entityId   String @map("entity_id")

  changes   Json? // Store before/after values
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

// ============================================
// INVITATIONS
// ============================================

model Invitation {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String
  role           UserRole @default(DONOR)
  token          String   @unique

  invitedById String @map("invited_by_id")

  // Relations (Organization is bitemporal — no @relation for it)
  invitedBy User @relation("InvitationsSent", fields: [invitedById], references: [id], onDelete: Cascade)

  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime         @map("expires_at")
  acceptedAt DateTime?        @map("accepted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, email])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ============================================
// ACCESS REQUESTS (Donor self-service)
// ============================================

model AccessRequest {
  id             String              @id @default(uuid())
  organizationId String              @map("organization_id")
  userId         String              @map("user_id")
  status         AccessRequestStatus @default(PENDING)
  message        String?             @db.Text

  // Review
  reviewedBy String?   @map("reviewed_by")
  reviewedAt DateTime? @map("reviewed_at")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation("AccessRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId, status], name: "idx_access_request_org_status")
  @@map("access_requests")
}

enum AccessRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum DonorAccessMode {
  AUTO_APPROVE
  REQUIRE_APPROVAL
}

// ============================================
// FUNDRAISING CAMPAIGNS
// ============================================

model Campaign {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  accountId      String         @map("account_id") // Stable entity ID of the linked Revenue account

  name           String
  description    String?        @db.Text // Planned usage of funds
  targetAmount   Decimal?       @map("target_amount") @db.Decimal(12, 2)
  status         CampaignStatus @default(ACTIVE)

  startDate      DateTime?      @map("start_date")
  endDate        DateTime?      @map("end_date")

  createdBy      String?        @map("created_by")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  @@unique([organizationId, accountId])
  @@index([organizationId, status], name: "idx_campaign_org_status")
  @@map("campaigns")
}

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// ============================================
// CONTACTS (Donors, Vendors, Payees/Payers)
// ============================================

model Contact {
  versionId      String @id @default(uuid()) @map("version_id")
  id             String @default(uuid())
  organizationId String @map("organization_id")

  // Contact details
  name    String
  type    ContactType @default(INDIVIDUAL)
  roles   ContactRole[]
  email   String?
  phone   String?
  address String?     @db.Text
  notes   String?     @db.Text

  // Link to platform user (when contact is a logged-in user)
  userId String? @map("user_id")

  isActive Boolean @default(true) @map("is_active")

  // Temporal versioning (bi-temporal pattern)
  previousVersionId String?   @map("previous_version_id")
  validFrom         DateTime  @default(now()) @map("valid_from")
  validTo           DateTime  @default("9999-12-31T23:59:59.999Z") @map("valid_to")
  systemFrom        DateTime  @default(now()) @map("system_from")
  systemTo          DateTime  @default("9999-12-31T23:59:59.999Z") @map("system_to")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  deletedBy         String?   @map("deleted_by")
  changedBy         String?   @map("changed_by")
  changeReason      String?   @map("change_reason") @db.Text

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (only to non-bitemporal User; Organization resolved at service layer)
  user User? @relation("UserContacts", fields: [userId], references: [id])

  // Index for looking up contact by user (uniqueness enforced in service layer for current versions)
  @@index([organizationId, userId], name: "idx_contact_org_user")

  // Temporal indexes
  @@unique([id, validFrom])
  @@index([id, validTo], name: "idx_contact_current")
  @@index([id, validFrom, validTo], name: "idx_contact_valid_time")
  @@index([systemFrom, systemTo], name: "idx_contact_system_time")
  @@index([isDeleted], name: "idx_contact_deleted")
  @@index([organizationId, isActive], name: "idx_contact_org_active")
  @@map("contacts")
}

enum ContactType {
  INDIVIDUAL
  ORGANIZATION
}

enum ContactRole {
  DONOR
  VENDOR
}

// ============================================
// BILLS & PLEDGES (Payables / Receivables)
// ============================================

model Bill {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  contactId      String @map("contact_id")

  // Bill details
  direction   BillDirection
  status      BillStatus    @default(DRAFT)
  amount      Decimal       @db.Decimal(12, 2)
  amountPaid  Decimal       @default(0) @map("amount_paid") @db.Decimal(12, 2)
  description String        @db.Text

  // Dates
  issueDate      DateTime  @map("issue_date")
  dueDate        DateTime? @map("due_date")
  paidInFullDate DateTime? @map("paid_in_full_date")

  notes String? @db.Text

  // Accrual transaction created when bill is entered
  accrualTransactionId String? @unique @map("accrual_transaction_id")

  // For PAYABLE bills: which cash/bank account will fund the payment
  fundingAccountId String? @map("funding_account_id")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")

  // Relations (Organization, Contact, and Transaction are bitemporal — no @relation for those)
  payments           BillPayment[]

  @@index([organizationId, status], name: "idx_bill_org_status")
  @@index([organizationId, direction], name: "idx_bill_org_direction")
  @@index([contactId], name: "idx_bill_contact")
  @@index([dueDate], name: "idx_bill_due_date")
  @@map("bills")
}

enum BillDirection {
  PAYABLE    // Money owed to a vendor
  RECEIVABLE // Money expected from a donor/payer
}

enum BillStatus {
  DRAFT
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

model BillPayment {
  id            String  @id @default(uuid())
  billId        String  @map("bill_id")
  transactionId String  @map("transaction_id")
  notes         String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  // Relations (Transaction is bitemporal — no @relation for it)
  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId], name: "idx_billpayment_bill")
  @@index([transactionId], name: "idx_billpayment_transaction")
  @@map("bill_payments")
}

// ============================================
// FILE ATTACHMENTS (Vercel Blob)
// ============================================

model Attachment {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Polymorphic link to parent entity
  entityType String @map("entity_type") // "TRANSACTION" | "BILL"
  entityId   String @map("entity_id")

  // File metadata
  fileName String @map("file_name")
  fileSize Int    @map("file_size") // bytes
  mimeType String @map("mime_type")
  blobUrl  String @map("blob_url")

  // Audit
  uploadedBy String?  @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@index([organizationId, entityType, entityId], name: "idx_attachment_org_entity")
  @@index([entityType, entityId], name: "idx_attachment_entity")
  @@map("attachments")
}
